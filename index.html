<!doctype html>
<html>
<body>
  <button id="connect">Connect & Read once</button>
  <pre id="log"></pre>

<script>
const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
const CHAR_UUID    = "beb5483e-36e1-4688-b7f5-ea07361b26a8";

const logEl = document.getElementById("log");
const log = (m) => { logEl.textContent += m + "\n"; };

let device = null;
let server = null;
let ch = null;

document.getElementById("connect").onclick = async () => {
  try {
    log("Requesting device, and BLE setup...");
    device = await navigator.bluetooth.requestDevice({
      filters: [{ services: [SERVICE_UUID] }],
    });

    device.addEventListener("gattserverdisconnected", onDisconnected);

    //log("Connecting GATT...");
    server = await device.gatt.connect();
    //log("Getting service...");
    const service = await server.getPrimaryService(SERVICE_UUID);
    //log("Getting characteristic...");
    ch = await service.getCharacteristic(CHAR_UUID);

    log("Reading value once...");
    const dv = await ch.readValue();       // DataView
    const value = decodeText(dv);
    log("Allineamento floor: " + value + " °");

    log("Disconnecting...");
    device.gatt.disconnect();

  } catch (e) {
    log("❌ " + e.name + ": " + e.message);
    safeDisconnect();
  }
};

function onDisconnected() {
  log("Device disconnected.");
  // Eventuale pulizia UI
}

// Decodifica robusta del DataView (UTF-8 testuale)
function decodeText(dataView) {
  // Copia i byte esattamente letti (evita extra padding del buffer)
  const bytes = new Uint8Array(dataView.buffer, dataView.byteOffset, dataView.byteLength);
  return new TextDecoder().decode(bytes).trim();
}

function safeDisconnect() {
  try {
    if (device?.gatt?.connected) device.gatt.disconnect();
  } catch (_) {}
}
</script>
</body>
</html>
 
